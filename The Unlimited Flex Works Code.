-- Define Services and Player
local player = game:GetService("Players").LocalPlayer
local backpack = player:FindFirstChild("Backpack")
local starterGear = player:FindFirstChild("StarterGear")
local replicatedStorage = game:GetService("ReplicatedStorage")
local userInputService = game:GetService("UserInputService")
local runService = game:GetService("RunService")

local soundFolder = nil
local track = nil
local isPlaying = false
local executedPlayers = {} -- Stores players who executed the script

-- Create a BindableEvent for Flexworks users only
local flexworksEvent = replicatedStorage:FindFirstChild("FlexworksExclusive") or Instance.new("BindableEvent", replicatedStorage)
flexworksEvent.Name = "FlexworksExclusive"

-- Function to Create and Store the Tool Persistently
local function createTool()
    local tool = Instance.new("Tool")
    tool.Name = "Unlimited Flexworks"
    tool.RequiresHandle = false
    tool.Parent = backpack

    -- Ensure the tool is stored in StarterGear (persists after resets)
    if starterGear then
        local clonedTool = tool:Clone()
        clonedTool.Parent = starterGear
    end

    return tool
end

-- Ensure the tool exists
local tool = backpack:FindFirstChild("Unlimited Flexworks") or createTool()

-- Function to Play Animation
local function playAnimation()
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:FindFirstChildOfClass("Humanoid")

    if humanoid then
        local animator = humanoid:FindFirstChildOfClass("Animator") or Instance.new("Animator", humanoid)
        animator.Parent = humanoid -- Ensure animator is attached to humanoid

        local animation = Instance.new("Animation")
        animation.AnimationId = "rbxassetid://77727115892579"
        local track = animator:LoadAnimation(animation)
        track:Play()

        return track.Length -- Returns animation duration
    end

    return 3 -- Default to 3 seconds if animation fails
end

-- Function to Play Audio for All Executed Users
local function playAudio()
    for _, user in pairs(executedPlayers) do
        if user and user.Character then
            local character = user.Character
            local soundFolder = character:FindFirstChild("SoundFolder") or Instance.new("Folder", character)
            soundFolder.Name = "SoundFolder"

            local audioIDs = {"99126314241685", "95410275491981", "128136381213631"}

            for _, id in pairs(audioIDs) do
                local sound = Instance.new("Sound")
                sound.SoundId = "rbxassetid://" .. id
                sound.Volume = 2
                sound.Looped = false
                sound.Parent = soundFolder
                sound:Play()
            end
        end
    end
end

-- Tool Equipped Function (Prevents Spam)
tool.Equipped:Connect(function()
    if isPlaying then return end

    isPlaying = true
    tool.Parent = backpack

    local duration = playAnimation()
    playAudio()

    task.spawn(function()
        wait(duration)
        isPlaying = false
    end)
end)

-- Ensure the Tool is Always in Slot 8
runService.Stepped:Connect(function()
    if backpack and backpack:FindFirstChild(tool.Name) then
        local tools = backpack:GetChildren()
        if #tools >= 8 then
            local foundTool = backpack:FindFirstChild(tool.Name)
            if foundTool then
                foundTool.Parent = player.Character
                wait(0.1)
                foundTool.Parent = backpack
            end
        end
    end
end)

-- Function to Refresh Players Automatically Without Lagging
local function refreshExecutors()
    executedPlayers = {} -- Clear existing players
    for _, v in pairs(game:GetService("Players"):GetPlayers()) do
        if v:FindFirstChild("Backpack") and v.Backpack:FindFirstChild("Unlimited Flexworks") then
            table.insert(executedPlayers, v)
        end
    end
end

-- Ensure Tool Persists After Reset
player.CharacterAdded:Connect(function()
    wait(1)
    backpack = player:FindFirstChild("Backpack") or player:WaitForChild("Backpack")
    starterGear = player:FindFirstChild("StarterGear")

    if not backpack:FindFirstChild("Unlimited Flexworks") then
        createTool().Parent = backpack
    end

    -- Check if player is already in executedPlayers before adding them
    local alreadyExists = false
    for _, v in pairs(executedPlayers) do
        if v == player then
            alreadyExists = true
            break
        end
    end

    -- If player is new, add them to executedPlayers
    if not alreadyExists then
        table.insert(executedPlayers, player)
        game.StarterGui:SetCore("SendNotification", {
            Title = "Unlimited Flexworks",
            Text = "Another user has executed the script!",
            Duration = 3
        })
    end

    refreshExecutors() -- Automatically refresh executor list after reset
end)

-- Function to Force Reset the Player
local function forceReset()
    player.Character:BreakJoints() -- Forces reset
end

-- Function to Count Players with Script
local function countExecutors()
    refreshExecutors() -- Ensures updated list before counting
    return #executedPlayers
end

-- Create a Circular Transparent UI Button with Black Outline
local function createUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Parent = game.CoreGui

    local button = Instance.new("TextButton")
    button.Size = UDim2.new(0, 50, 0, 50) -- Circular size
    button.Position = UDim2.new(0.85, 0, 0.1, 0) -- Adjust position
    button.BackgroundTransparency = 0.5 -- Semi-transparent
    button.BackgroundColor3 = Color3.new(0, 0, 0) -- Black outline effect
    button.Text = "" -- No text
    button.Parent = screenGui

    -- Make it a circular button
    local uiCorner = Instance.new("UICorner")
    uiCorner.CornerRadius = UDim.new(1, 0) -- Full circle
    uiCorner.Parent = button

    -- Outer border effect
    local uiStroke = Instance.new("UIStroke")
    uiStroke.Thickness = 2
    uiStroke.Color = Color3.new(1, 1, 1) -- White outline for visibility
    uiStroke.Parent = button

    -- Refresh Functionality
    local function refreshCount()
        game.StarterGui:SetCore("SendNotification", {
            Title = "Flexworks Users",
            Text = "Users with script: " .. countExecutors(),
            Duration = 3
        })
    end

    -- Button Press (Mobile)
    button.MouseButton1Click:Connect(refreshCount)

    -- PC Keybind (END Key)
    userInputService.InputBegan:Connect(function(input, gameProcessed)
        if input.KeyCode == Enum.KeyCode.End and not gameProcessed then
            refreshCount()
        elseif input.KeyCode == Enum.KeyCode.F5 and not gameProcessed then
            forceReset() -- Pressing F5 forces reset
        end
    end)
end

-- Create the UI Button
createUI()
-- i fucking give up updating this shit
