-- ‚úÖ Force HttpService to allow external requests (Fixes executor restrictions)
pcall(function()
    setfflag("HttpService", "true")
    setfflag("AllowHttpRequests", "true")
end)

-- üöÄ Auto-Detect Workspace Directory
local function getWorkspacePath()
    if syn and syn.request then
        return "synapse/workspace/"
    elseif getcustomasset then
        return "workspace/"
    elseif isfolder and isfile then
        return "autoexec/"  -- Fallback for other executors
    else
        warn("‚ö†Ô∏è Executor workspace not found! Using default.")
        return "./"  -- Default to current directory
    end
end

local workspacePath = getWorkspacePath()
local imageFileName = "shift_icon.png"
local imagePath = workspacePath .. imageFileName

-- ‚úÖ Image URL (Raw from GitHub)
local imageUrl = "https://raw.githubusercontent.com/Justanewplaye/Unlimited-Flex-Works/refs/heads/main/12e40e625eb48f14b4765cf26fc2993c.png"

-- ‚úÖ Function to check and download the image
local function fetchAndStoreImage()
    if isfile(imagePath) then
        print("‚úÖ Image already exists in workspace: " .. imagePath)
        return true
    end

    -- üöÄ Auto-Download Image
    local requestFunction = syn and syn.request or http_request or request
    if not requestFunction then
        warn("‚ö†Ô∏è Your executor does not support external requests.")
        return false
    end

    local response = requestFunction({Url = imageUrl, Method = "GET"})
    if response and response.StatusCode == 200 then
        if not isfolder(workspacePath) then
            makefolder(workspacePath)  -- ‚úÖ Create the workspace folder if missing
        end
        writefile(imagePath, response.Body)  -- ‚úÖ Save image to workspace
        print("‚úÖ Image downloaded and saved to: " .. imagePath)
        return true
    else
        warn("‚ö†Ô∏è Failed to download image!")
        return false
    end
end

-- ‚úÖ Function to Load Image from File
local function loadImageAsset()
    if isfile(imagePath) then
        if getsynasset then
            return getsynasset(imagePath)
        elseif getcustomasset then
            return getcustomasset(imagePath)
        elseif loadfile then
            return "file://" .. imagePath
        else
            warn("‚ö†Ô∏è No valid method to load image asset!")
            return nil
        end
    else
        warn("‚ö†Ô∏è Image file missing: " .. imagePath)
        return nil
    end
end

-- ‚úÖ Create GUI and Buttons
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ShiftEmulatorGui"
screenGui.ResetOnSpawn = false  -- ‚úÖ Keeps GUI after respawn
screenGui.Parent = game:GetService("CoreGui")

-- üî• Main Button
local button = Instance.new("ImageButton")
button.Name = "ShiftButton"
button.Size = UDim2.new(0, 75, 0, 75)
button.Position = UDim2.new(0.85, 0, 0.75, 0)
button.BackgroundTransparency = 1
button.ScaleType = Enum.ScaleType.Fit
button.Parent = screenGui

-- ‚úÖ Add rounded edges
local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0.3, 0)
uiCorner.Parent = button

-- ‚úÖ Load Image from Workspace
spawn(function()
    if fetchAndStoreImage() then
        local imageAsset = loadImageAsset()
        if imageAsset then
            button.Image = imageAsset
            button.ScaleType = Enum.ScaleType.Fit
            print("‚úÖ Image successfully loaded from workspace!")
        else
            warn("‚ö†Ô∏è Image could not be loaded!")
        end
    end
end)

-- ‚úÖ Right Shift Emulator Function
local function emulateRightShift()
    local VirtualInputManager = game:GetService("VirtualInputManager")
    if VirtualInputManager then
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.RightShift, false, nil)
        wait(0.1)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.RightShift, false, nil)
    else
        warn("‚ö†Ô∏è VirtualInputManager not available in this executor.")
    end
end

-- ‚úÖ Draggable Button with Drag Mode Toggle
local UserInputService = game:GetService("UserInputService")
local dragging, dragInput, dragStart, startPos
local dragMode = false  -- ‚úÖ Drag Mode Off by Default

-- üî• Drag Mode Toggle Button (Top Right Corner)
local dragButton = Instance.new("TextButton")
dragButton.Name = "DragModeButton"
dragButton.Size = UDim2.new(0, 200, 0, 50)
dragButton.Position = UDim2.new(1, -210, 0, 10)  -- Top Right
dragButton.BackgroundColor3 = Color3.fromRGB(0, 0, 0)  -- Black Button
dragButton.TextColor3 = Color3.fromRGB(255, 255, 255)  -- White Text
dragButton.Text = "Enable Drag Mode"  -- Default Off
dragButton.Font = Enum.Font.SourceSansBold
dragButton.TextSize = 20
dragButton.Parent = screenGui

-- ‚úÖ Toggle Drag Mode Function
dragButton.MouseButton1Click:Connect(function()
    dragMode = not dragMode  -- Toggle State
    if dragMode then
        dragButton.Text = "Disable Drag Mode"
        button.Active = false  -- ‚úÖ Disables Button Actions
    else
        dragButton.Text = "Enable Drag Mode"
        button.Active = true  -- ‚úÖ Enables Button Actions
    end
end)

-- ‚úÖ Dragging Function (Works Only in Drag Mode)
local function update(input)
    if not dragMode then return end  -- ‚úÖ Dragging Only When Enabled
    local delta = input.Position - dragStart
    local newX = startPos.X.Offset + delta.X
    local newY = startPos.Y.Offset + delta.Y

    -- Prevents button from going out of screen bounds
    local screenSize = game:GetService("GuiService"):GetScreenResolution()
    local buttonSize = button.AbsoluteSize

    local clampedX = math.clamp(newX, 0, screenSize.X - buttonSize.X)
    local clampedY = math.clamp(newY, 0, screenSize.Y - buttonSize.Y)

    button.Position = UDim2.new(0, clampedX, 0, clampedY)
end

-- ‚úÖ PC Dragging (Only When Drag Mode is On)
button.InputBegan:Connect(function(input)
    if dragMode and input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = button.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

button.InputChanged:Connect(function(input)
    if dragMode and input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragMode and dragging and input == dragInput then
        update(input)
    end
end)
